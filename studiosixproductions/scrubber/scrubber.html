<!DOCTYPE html>
<html>
	<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	 <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	 <script src="raphael.min.js"></script>
	 <script src="raphael.filter.js"></script>
	 <!-- // <script src="raphael.dropshadow.js"></script> -->
	 <style>
	 body{background: #000;font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
   font-weight: 300;color:#fff;text-align: center;}
   h1,h2, h3{font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
   font-weight: 300;}
	 	path{z-index: 2;position: absolute;}
	 	#track{z-index: 0;}
	 	#scrubber-container{margin:0 auto;width:300px;background:#000000;}
	 	.dropshadow{
	 		background:#fff;
	 		color:#fff;
	 		filter: url(#dropshadow);
	 	}
	 </style>
	</head>
	<body>
		<div id="scrubber-container"></div>
		<div id="scrubber-container2"></div>
		<h1>Velocity : <span id="velocity">0</span></h1>
<script>
(function(window, document, undefined){
	/**
	 * Scrubber UI Component
	 * @author Matt Null -- hello@mattnull.com
	 * Class is dependent on jQuery and RaphaelJS
	 */
  
	var Scrubber = function(params){
		
		var config = {
			containerID : 'scrubber-container',
			canvasWidth : 300,
			canvasHeight : 300,
			innerRadius : 95,
			unreadBarColor : '#9E00FD',
			readBarColor : '#D300EB',
			trackColor : '#FFFFFF',
			strokeWidth : 60,
			trackWidth : 65,
			innerCircleBackground : 'center-bg.png',
			textOffset : 15,
			startTime : (new Date()).getTime()
		};

		this.config = $.extend({}, config, params);

		this.months = [
			'January',
			'February',
			'March',
			'April',
			'May',
			'June',
			'July',
			'August',
			'September',
			'October',
			'November',
			'December'
		];
		var self = this;

		this.R = R = this.config.innerRadius;
		this.paper = Raphael("scrubber-container", this.config.canvasWidth, this.config.canvasHeight);
		this.selector = '#'+ this.config.containerID;
		var canvasPosition = $(this.selector + ' svg').offset();
	    this.centerX = canvasPosition.left + (this.config.canvasWidth / 2);
		this.centerY = canvasPosition.top + (this.config.canvasHeight / 2);
	   
	    var d = new Date(this.config.startTime);
	    this.day= d.getDate();
	  	this.month = d.getMonth();
	    this.year = d.getFullYear();
	    this.hours = d.getHours();
	    this.minutes = d.getMinutes();
	    this.lastVal = 0;

		this.paper.customAttributes.arc = function (value, total, R) {
	        var alpha = value == 360 ? 359 : 360 / total * value,
	            a = (90 - alpha) * Math.PI / 180,
	            x = (self.config.canvasWidth / 2) + R * Math.cos(a),
	            y = (self.config.canvasHeight / 2) - R * Math.sin(a),
	            path;

			path = [["M", self.config.canvasWidth / 2, self.config.canvasHeight / 2 - R], ["A", R, R, 0, +(alpha > 180), 1, x, y]];	

	        return {path: path};
	    };

	    this.drawInnerCircle();
	    this.drawTrack();
	    this.drawUnreadBar(90);
	    this.drawReadBar(45);
	    this.drawTime();
	    this.drawDate();
	    
	    this.attachEvents();
	};
	
	Scrubber.prototype.attachEvents = function(){
		var self = this;

        if(this.isTouchDevice()){
        	var handleTouchMove = function(e){
        		e.preventDefault();
			    var touch = e.touches[0];
			    var x = touch.pageX;
			    var y = touch.pageY;
			    self.scrub(x, y);
			    self.trackVelocity(x, y);
        	};

			document.getElementById('track').addEventListener('touchmove', handleTouchMove, false);
			document.getElementById('readbar').addEventListener('touchmove', handleTouchMove, false);
			document.getElementById('unreadbar').addEventListener('touchmove', handleTouchMove, false);
		}
		else{
			var handleDrag = function(dx, dy, x, y, e){
			   	self.scrub(x, y);
			    self.trackVelocity(x, y);
			};

			//set the drag event for each path object
			this.paper.set(this.track, this.unreadBar, this.readBar).drag(handleDrag);
		}

		$(this.selector + ' text').on('click', function(){
			var el = $(this);
			if(el.attr('minimized')){
				el.removeAttr('minimized');
				self.maximize();
			}
			else{
				el.attr('minimized', true);
				self.minimize();
			}
		});
	};

	Scrubber.prototype.drawInnerCircle = function(){
		console.log('CIRCLE',this.config)
		
		var background = this.paper.image(this.config.innerCircleBackground, this.config.trackWidth + 17, this.config.trackWidth + 17, this.config.canvasWidth / 2 - 15, this.config.canvasHeight / 2 - 15);
		// track.node.setAttribute("class", "dropshadow");
	};

	Scrubber.prototype.drawTrack = function(angle){

		this.track = this.paper.path().attr({
	    	'stroke': this.config.trackColor, 
	    	'stroke-width': this.config.trackWidth, 
	    	'stroke-linecap' : 'round'
	    }).animate({arc: [360, 360, this.R]});
	
	    this.track.node.id = "track";

		// track.node.setAttribute("class", "dropshadow");
	};

	Scrubber.prototype.drawReadBar = function(angle){

	   	this.readBar = this.paper.path().attr({
	   		'stroke': this.config.readBarColor, 
	   		'stroke-width': this.config.strokeWidth, 
	   		'stroke-linecap' : 'round'
	   	}).animate({arc: [angle, 360, this.R]}); 

	   	this.readBar.node.id = "read";
	}

	Scrubber.prototype.drawUnreadBar = function(angle){

	    this.unreadBar = this.paper.path().attr({
	    	'stroke': this.config.unreadBarColor, 
	    	'stroke-width': this.config.strokeWidth, 
	    	'stroke-linecap' : 'round'
	    }).animate({arc: [angle, 360, this.R]}); 

	   	this.unreadBar.node.id = "unread";
	};

	Scrubber.prototype.isTouchDevice = function(){
		var el = document.createElement('div');
		el.setAttribute('ongesturestart', 'return;');
		return typeof el.ongesturestart === "function";
	};

	Scrubber.prototype.drawDate = function(){

	   this.date = this.paper.text(this.config.canvasWidth / 2, (this.config.canvasHeight / 2) - this.config.textOffset, this.day + ' '+ this.months[this.month] + ' '+ this.year)
        .attr({
        	'fill' : '#ffffff',
        	'font-size' : '12px',
        	'cursor' : 'pointer'
        });

	};

	Scrubber.prototype.drawTime = function(){
		var min = this.minutes;
        var hr = this.hours;

        if(this.minutes < 10){
        	min = '0' + this.minutes;
        }
        if(this.hours < 10){
        	hr = '0' + this.hours;
        }

        this.time = this.paper.text(this.config.canvasWidth / 2, (this.config.canvasHeight / 2) + this.config.textOffset, hr + ':' + min).attr({
        	'fill' : '#ffffff',
        	'font-size' : '38px',
        	'cursor' : 'pointer'
        });
	};

	Scrubber.prototype.trackVelocity = function(x, y){
    	var t = (new Date()).getTime();
    	var velocity = this.velocity
    	var lastX = this.lastX;
    	var lastTime = this.lastTime;

		if(lastX > 0){
			velocity =  (x - lastX) / (t - lastTime);
		}

		this.lastX = x;
		this.lastTime = t;
		this.velocity = velocity < 0 ? Math.floor(-velocity * 100) : Math.floor(velocity * 100);
		console.log(velocity)
		//FOR DEMO ~~~~~~~~~~~~~~~~~~
		$('#velocity').text(this.velocity);
		return velocity;
    };

    Scrubber.prototype.updateTime = function(){
    	var min = this.minutes;
    	var hr = this.hours;

    	if(this.minutes < 10){
    		min = '0' + this.minutes;
    	}

    	if(this.hours < 10){
    		hr = '0' + this.hours;
    	}

    	this.time.attr({text: hr + ':' + min});
    };

    Scrubber.prototype.scrub = function(x, y){
		var deltaX = x - this.centerX;
		var deltaY = y - this.centerY;		
		var angle = (Math.atan2(deltaY, deltaX) * 180 / Math.PI) + 90;

		var val = (angle < 0) ? 360 + angle : angle;

		console.log('x', x,'y',y, 'angle', angle, 'value', val)
		
		//Time update
		if(val < this.lastVal){ // we are decreasing
			
			if(this.hours == 0 && this.minutes == 0){
				this.day--;			
				this.hours = 24;
				this.minutes = 59;
				this.date.attr({text: this.day + ' '+ this.months[this.month] + ' '+ this.year});
				this.updateTime();
			}
			else if(this.minutes == 0){
				this.minutes = 59;
				this.hours--;
				this.updateTime();
			}
			else{
				this.minutes--;
				this.updateTime();
			}
		}
		else{ // we are increasing

			if(this.hours == 24 && this.minutes == 59){
				this.day++; //increase the day
				this.hours = 0; // reset hours
				this.minutes = 0; //reset minutes
				this.date.attr({text: this.day + ' '+ this.months[this.month] + ' '+ this.year});
				this.updateTime();
			}
			else if(this.minutes < 59){
				this.minutes++; //increase minutes
				this.updateTime();
			}
			else{
				this.hours++;
				this.minutes = 0;
				this.updateTime();
			}
		}

		if(val == 0 || angle > 359) return;

		//el.animate({arc: [val, 360, R]});
		this.lastVal = val;
    };

    Scrubber.prototype.minimize = function(){
    	//DUMMY CODE
    	//clearInterval(interval);
    	//END DUMMY CODE

    	R = 65;
    	this.track.attr({stroke: this.config.trackColor, 'stroke-width': 15}).animate({arc: [359, 360, R]});
   	 	this.unreadBar.attr({stroke: this.config.unreadBarColor, 'stroke-width': 10, 'stroke-linecap' : 'round'}).animate({arc: [this.unreadBar.attrs.arc[0], 360, R]}); 
   		this.readBar.attr({stroke: this.config.readBarColor, 'stroke-width': 10, 'stroke-linecap' : 'round'}).animate({arc: [this.readBar.attrs.arc[0], 360, R]});

   		//DUMMY CODE
    	//dummyInterval();
    	//END DUMMY CODE
    };

    Scrubber.prototype.maximize = function(){
    	//DUMMY CODE
    	//clearInterval(interval);
    	//END DUMMY CODE
    	R = 95;	
    	this.track.attr({stroke: this.config.trackColor, 'stroke-width': this.config.trackWidth}).animate({arc: [359, 360, R]});
   	 	this.unreadBar.attr({stroke: this.config.unreadBarColor, 'stroke-width': this.config.strokeWidth, 'stroke-linecap' : 'round'}).animate({arc: [this.unreadBar.attrs.arc[0], 360, this.R]}); 
   		this.readBar.attr({stroke: this.config.readBarColor, 'stroke-width': this.config.strokeWidth, 'stroke-linecap' : 'round'}).animate({arc: [this.readBar.attrs.arc[0], 360, this.R]});

   		//DUMMY CODE
    	//dummyInterval();
    	//END DUMMY CODE
    };

    //USAGE
    $(function(){
	    
	    var scrubber = new Scrubber({});


		//DUMMY DATA~~~~~~~~~~~~~~~~~
		var val = 90;
		var interval;

		var dummyInterval = function(){
			interval = setInterval(function(){
				val += Math.random() * 25;
				if(val > 300) clearInterval(interval);
				scrubber.unreadBar.animate({arc: [val, 360, R]}, 500, "slide");
			}, 3000);
		}

		dummyInterval();
		//END DUMMY DATA~~~~~~~~~~~~
    });
          
})(window, document);
</script>
	</body>
</html>